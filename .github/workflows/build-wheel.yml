name: Build wheels

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch: [x86_64, aarch64]

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build wheel
        uses: addnab/docker-run-action@v3
        with:
          image: quay.io/pypa/manylinux_2_34_${{ matrix.arch }}
          options: |
            --platform linux/${{ matrix.arch == 'aarch64' && 'arm64' || 'amd64' }}
            -v ${{ github.workspace }}:/io
          run: |
            set -e

            cd /io/BinaryOptionsToolsV2

            yum install -y \
              openssl-devel \
              pkgconfig \
              git \
              python3-devel

            curl https://sh.rustup.rs -sSf | sh -s -- -y
            source $HOME/.cargo/env

            python3 -m pip install --upgrade pip maturin

            export OPENSSL_DIR=/usr
            export OPENSSL_LIB_DIR=/usr/lib64
            export OPENSSL_INCLUDE_DIR=/usr/include

            maturin build --release --strip
