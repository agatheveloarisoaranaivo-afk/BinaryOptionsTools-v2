name: Build wheels (x86_64 + aarch64)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, aarch64]

    steps:
      - uses: actions/checkout@v4

      - name: Build wheel in container
        run: |
          if [ "${{ matrix.arch }}" = "aarch64" ]; then
            IMAGE=quay.io/pypa/manylinux_2_28_aarch64
            PLATFORM=linux/arm64
            TARGET=aarch64-unknown-linux-gnu
          else
            IMAGE=quay.io/pypa/manylinux_2_28_x86_64
            PLATFORM=linux/amd64
            TARGET=x86_64-unknown-linux-gnu
          fi

          docker run --rm --platform $PLATFORM \
            -v $PWD:/io \
            $IMAGE \
            bash -c "
              yum install -y python3 python3-pip openssl-devel pkgconfig gcc git curl zip
              python3 -m pip install --upgrade pip
              python3 -m pip install maturin
              cd /io/BinaryOptionsToolsV2
              export CARGO_BUILD_TARGET=$TARGET
              maturin build --release --out /io/wheels
            "

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.arch }}
          path: wheels/
